---
interface Props {
  src: string
}

const { src } = Astro.props
---

<preview-view data-src={src}>
  <button
    type="button"
    aria-label="Toggle preview mode"
    aria-pressed="true"
    class="inline-flex items-center gap-2 rounded-lg border border-stone-300 px-4 py-2 font-medium shadow-sm focus:ring-2 focus:ring-pink-500 focus:outline-0"
  >
    <span data-emoji aria-hidden="true">ðŸ‘€</span>
    <span data-text>Preview</span>
  </button>
</preview-view>

<script>
  class PreviewView extends HTMLElement {
    private clickHandler: ((event: Event) => void) | null = null

    connectedCallback() {
      const src = this.dataset.src

      if (!src) {
        return
      }

      const button = this.querySelector('button')

      if (!button) {
        return
      }

      const emoji = button.querySelector('span[data-emoji]')
      const text = button.querySelector('span[data-text]')

      if (!emoji || !text) {
        return
      }

      this.clickHandler = () => {
        const isPreviewing = button.getAttribute('aria-pressed') === 'true'
        const newState = !isPreviewing

        button.setAttribute('aria-pressed', String(newState))

        emoji.textContent = newState ? 'ðŸ‘€' : 'ðŸ‘¾'
        text.textContent = newState ? 'Preview' : 'HTML'

        document.dispatchEvent(
          new CustomEvent(`preview:view:${src}`, {
            bubbles: true,
            detail: {
              previewing: newState,
            },
          })
        )
      }

      button.addEventListener('click', this.clickHandler)
    }

    disconnectedCallback() {
      const button = this.querySelector('button')

      if (button && this.clickHandler) {
        button.removeEventListener('click', this.clickHandler)

        this.clickHandler = null
      }
    }
  }

  customElements.define('preview-view', PreviewView)
</script>
