---
interface Props {
  src: string
}

const { src } = Astro.props
---

<preview-copy data-src={src} class="hidden md:block">
  <button
    type="button"
    aria-label="Copy HTML"
    aria-pressed="false"
    class="inline-flex items-center gap-2 rounded-lg border border-stone-300 px-4 py-2 font-medium shadow-sm focus:ring-2 focus:ring-pink-500 focus:outline-0"
  >
    <span data-emoji aria-hidden="true">ðŸ“‹</span>
    <span data-text>Copy</span>
  </button>

  <span data-polite aria-live="polite" class="sr-only"> </span>
</preview-copy>

<script>
  class PreviewCopy extends HTMLElement {
    private timeoutId: number | null = null
    private isProcessing = false
    private clickHandler: ((event: Event) => void) | null = null

    connectedCallback() {
      const src = this.dataset.src

      if (!src) {
        return
      }

      const button = this.querySelector('button')
      const emoji = button?.querySelector('span[data-emoji]')
      const text = button?.querySelector('span[data-text]')
      const polite = this.querySelector('span[data-polite]')

      if (!button || !emoji || !text || !polite) {
        return
      }

      this.clickHandler = () => {
        if (this.isProcessing) {
          return
        }

        this.isProcessing = true

        if (this.timeoutId !== null) {
          clearTimeout(this.timeoutId)
        }

        document.dispatchEvent(
          new CustomEvent(`preview:copy:${src}`, {
            bubbles: true,
          })
        )

        emoji.textContent = 'âœ…'
        text.textContent = 'Copied'
        polite.textContent = 'Copied to clipboard.'

        button.setAttribute('aria-pressed', 'true')

        this.timeoutId = window.setTimeout(() => {
          if (this.isConnected) {
            emoji.textContent = 'ðŸ“‹'
            text.textContent = 'Copy'
            polite.textContent = ''

            button.setAttribute('aria-pressed', 'false')
          }

          this.isProcessing = false
        }, 1500)
      }

      button.addEventListener('click', this.clickHandler)
    }

    disconnectedCallback() {
      const button = this.querySelector('button')

      if (button && this.clickHandler) {
        button.removeEventListener('click', this.clickHandler)

        this.clickHandler = null
      }

      if (this.timeoutId !== null) {
        clearTimeout(this.timeoutId)

        this.timeoutId = null
      }
    }
  }

  customElements.define('preview-copy', PreviewCopy)
</script>
