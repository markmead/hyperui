---
interface Props {
  src: string
}

const { src } = Astro.props

type CopyVariant = 'control' | 'animated' | 'gradient'

function getOrAssignVariant(): CopyVariant {
  const storageKey = 'hyperui:copy-variant'

  const availableVariants: CopyVariant[] = ['control', 'animated', 'gradient']

  const storedVariant = sessionStorage.getItem(storageKey)

  if (storedVariant && availableVariants.includes(storedVariant as CopyVariant)) {
    return storedVariant as CopyVariant
  }

  const randomVariant = availableVariants[Math.floor(Math.random() * availableVariants.length)]

  sessionStorage.setItem(storageKey, randomVariant)

  return randomVariant
}

const assignedVariant = getOrAssignVariant()

const variantClasses = {
  control: '',
  animated: 'animate-pulse hover:animate-none',
  gradient: 'bg-gradient-to-r from-pink-500 to-rose-500 text-white border-0',
}
---

<preview-copy data-src={src} data-variant={assignedVariant} class="hidden md:block">
  <button
    type="button"
    aria-label="Copy HTML"
    aria-pressed="false"
    class:list={[
      'inline-flex items-center gap-2 rounded-lg border border-stone-300 px-4 py-2 font-medium shadow-sm transition-all duration-200 focus:ring-2 focus:ring-pink-500 focus:outline-0',
      variantClasses[assignedVariant as CopyVariant],
      assignedVariant === 'animated' && 'hover:shadow-lg',
      assignedVariant === 'gradient' && 'hover:shadow-lg hover:shadow-pink-500/20',
    ]}
  >
    <span data-emoji aria-hidden="true">ðŸ“‹</span>
    <span data-text>Copy</span>
  </button>

  <span data-polite aria-live="polite" class="sr-only"> </span>
</preview-copy>

<script>
  type CopyVariant = 'control' | 'animated' | 'gradient'

  class PreviewCopy extends HTMLElement {
    private isProcessing = false
    private contentSrc: string | null = null
    private copyVariant: CopyVariant = 'control'
    private timeoutId: ReturnType<typeof setTimeout> | null = null

    private clickHandler: (() => void) | null = null

    connectedCallback() {
      this.contentSrc = this.dataset.src || null
      this.copyVariant = (this.dataset.variant as CopyVariant) || 'control'

      if (!this.contentSrc) {
        return
      }

      const buttonEl = this.querySelector('button') as HTMLButtonElement | null
      const politeEl = this.querySelector('span[data-polite]') as HTMLSpanElement | null

      if (!buttonEl || !politeEl) {
        return
      }

      const buttonEmoji = buttonEl?.querySelector('span[data-emoji]') as HTMLSpanElement | null
      const buttonText = buttonEl?.querySelector('span[data-text]') as HTMLSpanElement | null

      if (!buttonEmoji || !buttonText) {
        return
      }

      this.clickHandler = () => {
        if (this.isProcessing) {
          return
        }

        this.isProcessing = true

        if (this.timeoutId !== null) {
          clearTimeout(this.timeoutId)
        }

        document.dispatchEvent(
          new CustomEvent(`preview:copy:${this.contentSrc}`, {
            bubbles: true,
            detail: { variant: this.copyVariant },
          })
        )

        buttonEmoji.textContent = 'âœ…'
        buttonText.textContent = 'Copied'
        politeEl.textContent = 'Copied to clipboard.'

        buttonEl.setAttribute('aria-pressed', 'true')

        this.timeoutId = globalThis.setTimeout(() => {
          if (this.isConnected) {
            buttonEmoji.textContent = 'ðŸ“‹'
            buttonText.textContent = 'Copy'
            politeEl.textContent = ''

            buttonEl.setAttribute('aria-pressed', 'false')
          }

          this.isProcessing = false
        }, 1500)
      }

      buttonEl.addEventListener('click', this.clickHandler)
    }

    disconnectedCallback() {
      const buttonEl = this.querySelector('button') as HTMLButtonElement | null

      if (buttonEl && this.clickHandler) {
        buttonEl.removeEventListener('click', this.clickHandler)

        this.clickHandler = null
      }

      if (this.timeoutId !== null) {
        clearTimeout(this.timeoutId)

        this.timeoutId = null
      }
    }
  }

  customElements.define('preview-copy', PreviewCopy)
</script>
