---
interface Result {
  title: string
  emoji: string
  terms: string[]
  slug: string
}

interface Props {
  collections: Result[]
  posts: Result[]
}

const { collections, posts } = Astro.props
---

<search-results data-collections={JSON.stringify(collections)} data-posts={JSON.stringify(posts)}>
  <div
    data-container="false"
    class="absolute top-full mt-2 w-full rounded-lg border border-stone-300 bg-white py-1 shadow-lg data-[container=false]:hidden data-[container=true]:block"
  >
    <p data-error="false" class="px-4 py-2 text-stone-700 data-[error=false]:hidden">
      No results found.
    </p>

    <ul data-list role="listbox" class="max-h-72 divide-y divide-stone-200 overflow-y-auto"></ul>
  </div>
</search-results>

<script>
  interface Result {
    title: string
    emoji: string
    terms: string[]
    slug: string
  }

  class SearchResults extends HTMLElement {
    private escapeHandler: ((event: Event) => void) | null = null
    private searchHandler: ((event: Event) => void) | null = null
    private collections: Result[] = []
    private posts: Result[] = []

    connectedCallback() {
      const container = this.querySelector('[data-container]')
      const error = this.querySelector('[data-error]')
      const ul = this.querySelector('[data-list]')

      if (!container || !error || !ul) {
        return
      }

      try {
        this.collections = JSON.parse(this.dataset.collections || '[]')
        this.posts = JSON.parse(this.dataset.posts || '[]')
      } catch {
        return
      }

      this.escapeHandler = () => {
        ul.innerHTML = ''
        container.setAttribute('data-container', 'false')
        error.setAttribute('data-error', 'false')
      }

      this.searchHandler = (event: Event) => {
        const { detail } = event as CustomEvent

        const query = detail.value.toLowerCase()

        if (!query) {
          ul.innerHTML = ''

          container.setAttribute('data-container', 'false')
          error.setAttribute('data-error', 'false')

          return
        }

        container.setAttribute('data-container', 'true')

        const results = [...this.collections, ...this.posts].filter(({ title, terms = [] }) => {
          const includesTitle = title.toLowerCase().includes(query)
          const includesTerms = (terms as string[]).length
            ? (terms as string[]).some((term: string) => term.toLowerCase().includes(query))
            : false

          return includesTitle || includesTerms
        })

        if (results.length === 0) {
          ul.innerHTML = ''

          error.setAttribute('data-error', 'true')

          return
        }

        ul.innerHTML = results
          .map(
            ({ title, emoji, slug }) => `
          <li role="option">
            <a
              href="${slug}"
              class="block px-4 py-2 font-medium text-pretty text-stone-700 transition-colors hover:bg-stone-100 hover:text-stone-900 focus:ring-2 focus:ring-pink-500 focus:outline-0 focus:ring-inset"
            >
              <div class="flex gap-2">
                <span aria-hidden="true">${emoji}</span>
                <span>${title}</span>
              </div>
            </a>
          </li>
        `
          )
          .join('')

        error.setAttribute('data-error', 'false')
      }

      document.addEventListener('input:escape', this.escapeHandler)
      document.addEventListener('input:search', this.searchHandler)
    }

    disconnectedCallback() {
      if (this.escapeHandler && this.searchHandler) {
        document.removeEventListener('input:escape', this.escapeHandler)
        document.removeEventListener('input:search', this.searchHandler)
        this.escapeHandler = null
        this.searchHandler = null
      }

      this.collections = []
      this.posts = []
    }
  }

  customElements.define('search-results', SearchResults)
</script>
